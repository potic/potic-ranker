sudo: required

language: python

python:
- '2.7'

services:
- docker

before_install:
- openssl aes-256-cbc -K $encrypted_1eb2fcb0c1b2_key -iv $encrypted_1eb2fcb0c1b2_iv -in deployment_keys.tar.enc -out deployment_keys.tar -d
- tar xvf deployment_keys.tar

before_script:
- docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
- eval "$(ssh-agent -s)"
- chmod 600 deployment_keys/deploy_test
- ssh-add deployment_keys/deploy_test
- chmod 600 deployment_keys/deploy_prod
- ssh-add deployment_keys/deploy_prod

script:
- export DOCKER_REPO=potic/potic-ranker
- export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH | tr '/' '-' ; fi`
- export TAG_VERSION=`cat VERSION`.$TRAVIS_BUILD_NUMBER
- docker build -t $DOCKER_REPO:travis-$TRAVIS_BUILD_NUMBER .
- docker tag $DOCKER_REPO:travis-$TRAVIS_BUILD_NUMBER $DOCKER_REPO:$TAG
- docker tag $DOCKER_REPO:travis-$TRAVIS_BUILD_NUMBER $DOCKER_REPO:$TAG_VERSION
- docker push $DOCKER_REPO
- if [ "$TRAVIS_BRANCH" == "develop" ]; then ssh -o "StrictHostKeyChecking no" "$DEPLOY_TEST_USER"@"$DEPLOY_TEST_HOST" TAG_TO_DEPLOY=$TAG_VERSION ENVIRONMENT_NAME=test POCKET_APP_KEY=$POCKET_APP_KEY 'bash -s' < scripts/deploy.sh; fi
- if [ "$TRAVIS_BRANCH" == "master" ]; then ssh -o "StrictHostKeyChecking no" "$DEPLOY_PROD_USER"@"$DEPLOY_PROD_HOST" TAG_TO_DEPLOY=$TAG_VERSION ENVIRONMENT_NAME=prod POCKET_APP_KEY=$POCKET_APP_KEY 'bash -s' < scripts/deploy.sh; fi

env:
  global:
  - secure: ECCbRWBEN37DJ3PG+RfN78wTTby6tds7LRxQgs6yKtRvq2UCn/H1heeouq4MGbT8Ij58LvCzMcon3Cvs1FJ+49fQjlKIGOA8BUvrwKb4gPkCNvIUVo12vq5aQLjWLAj19GtLnV/QtTzMr7qBpTDwn26CszL+3OLjHddSMiEaHDep1xqim27y0AsNGIdn94tguxiJIJ7KnmrYGKxb2kwnVpwF76dF1bG9SRxx6+c6Z6Y3QQ32wGoaI2vlYc5IFT57uis5ZMupixOJb5JgvXic3M57aEUA8BRlfBitSz5NbtKCBWnRtybStOjX97gN/YfvewXWlu4a6fUCxYvUSArQiEfcBosDg+lmo3fCgLqpoFh5RXW6lF+H1LLNgkBEU64YB+6Jo3aLSPgy6wdgqywtkOzccDfOuO2ka5NISZmw90uR7UTF7xk5/3bkYHydf8KvDxQSNu5NV6Kbi6wmri64uDqlMECKJSKVhJAy+I+Pzdyh9xr1PwJiZ+9gVNeV7f/NvXwqep3lLD89kx0pFfVB/StMq1u/bPFiwnlEUwn/5ttg/BBS7/d5RJaq83d3uFhygtTklf0P0MhyW4+I42e57p8VdsAJdnzlW3tqVXDyGVK546sII/Q3lNH5XAQzPedo3z16KfMLtQmlKY9AT1r8Ix6QZgHEEi6s+WZLBAXWNuc= # DOCKER_USERNAME
  - secure: oEouElrD13Lwj6ClYZBHk36ehDBwfjOFmIo5nRgPlivR823P5Wb6ltrnEJ5A2GpyYgQsMydjrzMke+yGNK0WbBo83r1yO9V6lXd+YVDSkHDbR3RX6l2aqoCn5teyo9c11cOWHQLvYfMW7aOEVN9whNqbwG0Kv3t6dQJrrSceijHNuvh0WcqnwaaR2zYxKvBkzJWoljkBZR39KS8ewY+vF5A4+3ylYnNcoCtqP9sE4v8BiOG8dSO5wkRkeMyVEGOp4DSEqFGe1NtLauu5nvPU3qhpmlHnu1V1eWJy6B/En4k98eGuMTG6twFUydQ8AYWyRyDGRRLrF766OfbY+yzCeawf5Q0qWKQOCr0pB+gBBXrl3UEOLCWBtJZBELYX5IJ+I0+Nya33gcp9PuemBzfU49cVFRFPV6WjaZtUJPJGPynWZadZCfBACNTJGj+oDakMCOsccHRDHSjSfRidxeBTowouYy5wb86rHeafV9D5VkFMtKsXemoJ9j2rnR3TmK1O+Sy052osjQhBtlu2ZMDtbckDwIRGNeVx7x5LWnrqvxMszgYCMhmA81BuimCPn/BiU97ZeGf6QF035b/KsbZFXtCxRsy9N96EUj1ZWitZHg0DSZ9EFAMnydTPs6FH3HfdRSkvrqghDBySSKYk730hnH/42RQReREjxb/5exo8Y3g= # DOCKER_PASSWORD
  - secure: eHPsr/h9C/7qQA41QlytMKRoH1D5AGe296A9/Dji0pVfq7O3LQyJpr4Z7j1ElLX4bJElbjziWa0N4uUlLFLFEFSt6jmL3cZC9BpV5lrBYs2fZtDpPQhx8k/r1UK+UlqCEjKM6J468CI3peAKXReflet0ecvWJQqbCAObVbFk+0pdF2eZEuZNiTYKmqvziQzdnA3j5IvzXc9le1yKHvirgK0wWv+JHsIaOYxK8YulPDIBwgKGslVHvl1PCQe/3FtTABEIcuXg97n+VZFubWoFuPsKAcP6zqQiTCC3ky7pKzgoBeaTfvqa0Jdw48cO3sRk65QPokKaJi3Iu8GQBGOweW4UKTHw0+2COk1wLKHmnXJFjK4wE8kk0dgn5bk/56qh5uwmVDmivbNYV5avKacBCJRZVuRFqa7LubN/i6m0RzajOYfojgZg4oCNVDSfkihdUMAF4i+axxsF2A1U8Ee/knCnTLQ4HYsFEkzroYJspA3SiEbc0pIZt3pgErTObSIZQvsDjk2eHAEJbY8QrwCeQJWF5Y0naSU75Ptq8Q1JNFFg8phuA6Q3H1/TcYci8BPxnPaK9MbvvzOTJg07UOvwEwWARC97ClDKRJlgSrbkSGZAaxClwS7H6cNpsb81f7uzdDgKmft8nBG/YRp+XZSy/McT+HejPSz/JUDsCZdqtoc= # DEPLOY_TEST_USER
  - secure: GbixUTuEstafkaz430bAxOolOYG62jgwMbpXdCvTNdbZCvg3iWkR7dSau4R54QsqfTtoHJ+INQHEEAV1LW+8uJ7uZzwRiMtS+LRHXq+2L7e5BFT6521n/moD2aIbKxy741+nHeLXHSgphiFaWs61tA7wsNrHM3qkfGzdqZkO3N6bmFEzQO3jmX1UcAShLyBqxAEVY2F9gSBrD5tnpGZToCYjWgARbi8Tp4r9656LWGm8NZsx1yU1HIfMYyTLElqT4jChIYIc7S3E/UqHEq/QYP/oxU/BlQUzibfoK3pMSgDUIKU6WsWO7MKPu9BltYYQ6sRmGWUXytulEmswuQzMJ0MVSxJUM6vdBxMfCcXlMCk45YdzYjT1QFg+YMy7GJkKeKGpg+aR909BRM4urap/jVEyOdjH9Uy1Ua+Ciajf7b8BPFGY7rLr4gMMFes4Y/Qj+zRG2IJeXU5F+Aq84ACYmeOY9l63If20Fh77ziQuPTdgiZp4opKYQwQ3VqPsGGIJpPyYixUXS5mdGZ8Y/7QPJp0PCTlHfInePLEycSq7iivHXmgWzSVgERw9PcQdrIRinKshXKKS29apsZa5V8Cv2OeaxIO+82i+Vvtcn+MDV3OHG6oe2ovIJFAhuMp3JTKXW05Y10BTKDtmKiHDcVGKq9u0WCeYjb+muWXO71i8AXg= # DEPLOY_TEST_HOST
  - secure: m7OiFg1p2Wj2u84y9U7B5yFoFEi7BU1GAmxRIP/tuP9/m+MX/ZUh4iqTX+v7bGwFj38RA+M9GR/RB6uPMHQ/gzTNwFDY57o+X35fY8px5Bd4CG8OSa9dZtAYpl/HXDAhAGOZMaPY+Q6PgOZFi9jAVoLW+PxKrXZalmCUyU4piUWm99NYvFOQS50nDLXTQ1qiq0loMK7sP1e07SUhNB9g6B6eJYEHtuyDBrswCrWqriC1vvHDQOUDDL7OhIryiXcA71GbBU6aal5SSo/9nDh4RZ3OHBEz2ZHRz9yp8pvkK7VbUc7c213GwQBRKHdnnGEKvmGUOSo6jUVz3Nw7wAiW3RAiktr7BbA4m1RRS1fNBHSJfalMUypQ2phvX7lh9sPfns3yw0W9JwvwiE2Fkf+0cdoGNz7n0i5tA9xtPqr/YZMHGwvc9jMnB2nncs33eB9xSgDKkYZopt+Q74VF7Yor6A1utAGgzn1GTy5agmMHnU7mMPBGKdO2rRDmSIpyqEnexVZRff9XVnW0mvlYkkXouUky9W8kL1jpX/NbrzBZhwp8yePwTkmQHeC7VKEAUs3yahFxJrYE/ibH1SqpyWpV/0dWh7B6UtDvIJ/1OIjJhlqypONEmIrxvccjTEm55wDOh21rZfnDRxRGFBxiT40wkzx17gKYW+GbiCTQ2KF86Ks= # DEPLOY_PROD_USER
  - secure: LJIbtrNh3RAkMUPF99y07pTI4wpFIYVJuxTz6W1o7pNQ9XlSYFMb2MmCJLVxRcNWhdAIcVFiW8J2Euxt+uYyMG69MgYBWVpgfpJ4NhBimEeRYMmPpBAKWgrEpeg8aJyHC7S09DFLCVvq81ZgMyaWlx6zYYpmhbWwkKFx1FLjCJPaa23vHgtvG+QBwQQ7dkuGhzQPfZ2e1uIEjf3d2kvHB4OIXJgETPltW9eoUSAz1PAyrkQoc9TaKXFH1raxw+v+6rejNUUJ2nvnQsCUvYZ0y8UBLnF2KUwkchXVCK9tb+UhqFlTqmFgCxaOwIxumJ8mMbe9sZR0LSOM41SCDv4JIFdH9MmWEISamfy8+E6llSpZFdIEcSk58sOZfrdTfS59RlhZyukqxPR18U9hPxOnrtHhhkuZf3HDzyewnwVRYO3pd8xvy+3CeMN+k8Gq6GDQmbk1daB6AclMycODLDHZoGjeG/DBv51JeWC6oFjgWvPRkUccZXd9bG/DBGcVZ03mzE+Zr45x1pSlwNwH2n5IFZHREEuNkiiztUhgnpL3/Gjk52SWHkuGtmgd4hmoA2MKMmsrZ3olBuc4ikL8wHmvXssQ+cfUOYgZ4v7eUd/fUY4i2i+XF6rVO8ccHS4FxY3XQQsbRoUiQBpW/VA0wieyiHLGZL57NFLRJu5SoSr4VHM= # DEPLOY_PROD_HOST
